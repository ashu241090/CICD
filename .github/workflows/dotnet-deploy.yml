name: CI/CD for .NET to IIS (Staging â†’ Production)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    outputs:
      build-path: ${{ steps.publish.outputs.path }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.301'

      

      - name: Build solution
        run: dotnet build GITHUB-CICD.csproj --configuration Release

      - name: Publish project
        id: publish
        run: |
          dotnet publish -c Release -o publish
          echo "path=publish" >> $GITHUB_OUTPUT

  deploy-production:
    runs-on: windows-latest
    needs: build
    environment:
      name: production
      url: https://your-prod-site.com  # Optional
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Production IIS via Web Deploy
        shell: pwsh
        run: |
          "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe" -verb:sync `
          -source:contentPath="publish" `
          -dest:contentPath="Default Web Site/CICD",computerName="${{ secrets.DEPLOY_URL }}",userName="${{ secrets.DEPLOY_USER }}",password="${{ secrets.DEPLOY_PASSWORD }}",authType="Basic" `
          -allowUntrusted=true
