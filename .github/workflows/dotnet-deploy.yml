name: Build and Deploy ASP.NET (.NET Framework 4.7.2)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_PATH: ./GITHUB-CICD.csproj
  PUBLISH_DIR: ${{ github.workspace }}/publish



jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.1

      - name: Restore NuGet packages
        run: nuget restore GITHUB-CICD.sln

      - name: Build and Publish project
        run: |
          mkdir publish
          msbuild $env:PROJECT_PATH `
            /p:Configuration=Release `
            /p:DeployOnBuild=true `
            /p:WebPublishMethod=FileSystem `
            /p:PublishDir="$env:PUBLISH_DIR"

      - name: Deploy to IIS via Web Deploy
        run: |
          & "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe" `
              "-verb:sync" `
             "-source:contentPath='${{ env.PUBLISH_DIR }}'" `
             "-dest:contentPath='Default Web Site/CICD,computerName=https://172.16.1.233:8172/msdeploy.axd,userName=JINDALSAW\purchaseapp,password=Jsaw@123$,authType=Basic'" ` 
             "-allowUntrusted=true"

